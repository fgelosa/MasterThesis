apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srbacconstraint
spec:
  crd:
    spec:
      names:
        kind: K8sRbacConstraint
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srbac

        violation[{"msg": msg, "details": {"missing_roles": missing_roles}}] {
          some role
          provided_roles := {role | role := input.review.object.metadata.labels["role"]}
          required_roles := {"admin"}
          missing_roles := required_roles - provided_roles
          missing_roles != set()
          msg := sprintf("you must have the following roles: %v", [missing_roles])
        }
